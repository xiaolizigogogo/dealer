<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.utonw.utonerp.mapper.UserMapper">
    <resultMap id="BaseResultMap" type="com.utonw.dealer.api.entity.erp.User">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="uuid" property="uuid" jdbcType="VARCHAR"/>
        <result column="id" property="id" jdbcType="INTEGER"/>
        <result column="job_number" property="jobNumber" jdbcType="VARCHAR"/>
        <result column="password" property="password" jdbcType="VARCHAR"/>
        <result column="sex" property="sex" jdbcType="VARCHAR"/>
        <result column="active_flg" property="activeFlg" jdbcType="INTEGER"/>
        <result column="user_type" property="userType" jdbcType="VARCHAR"/>
        <result column="company_id" property="companyId" jdbcType="INTEGER"/>
        <result column="dept_id" property="deptId" jdbcType="INTEGER"/>
        <result column="id_card" property="idCard" jdbcType="VARCHAR"/>
        <result column="realname" property="realname" jdbcType="VARCHAR"/>
        <result column="nickname" property="nickname" jdbcType="VARCHAR"/>
        <result column="date_joined" property="dateJoined" jdbcType="DATE"/>
        <result column="position" property="position" jdbcType="VARCHAR"/>
        <result column="mobile" property="mobile" jdbcType="VARCHAR"/>
        <result column="email" property="email" jdbcType="VARCHAR"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="commissionRate" property="commissionRate" jdbcType="DOUBLE"/>
        <result column="data_access_level" property="dataAccessLevel" jdbcType="TINYINT" />
        <result column="verifiCode" property="verifiCode" jdbcType="INTEGER" />
        <result column="creatverifiCodetime" property="creatverifiCodetime" jdbcType="TIMESTAMP"/>
        <result column="account_name" property="accountName" jdbcType="VARCHAR"/>
        <collection ofType="com.utonw.dealer.api.entity.erp.UserLocate" property="userLocateList">
            <result property="id" column="locate_id" jdbcType="INTEGER"/>
            <result property="userId" column="locate_userId" jdbcType="VARCHAR"/>
            <result property="province" column="locate_province" jdbcType="VARCHAR"/>
            <result property="city" column="locate_city" jdbcType="VARCHAR"/>
            <result property="district" column="locate_district" jdbcType="VARCHAR"/>
            <result property="createDate" column="locate_create_date" jdbcType="TIMESTAMP"/>
        </collection>
    </resultMap>

    <resultMap id="UserRoleExtendMap" type="com.utonw.dealer.api.vo.UserRoleIdVo">
        <id column="uuid" property="uuid" jdbcType="VARCHAR"/>
        <result column="id" property="id" jdbcType="INTEGER"/>
        <result column="job_number" property="jobNumber" jdbcType="VARCHAR"/>
        <result column="password" property="password" jdbcType="VARCHAR"/>
        <result column="active_flg" property="activeFlg" jdbcType="INTEGER"/>
        <result column="user_type" property="userType" jdbcType="VARCHAR"/>
        <result column="company_id" property="companyId" jdbcType="INTEGER"/>
        <result column="dept_id" property="deptId" jdbcType="INTEGER"/>
        <result column="id_card" property="idCard" jdbcType="VARCHAR"/>
        <result column="realname" property="realname" jdbcType="VARCHAR"/>
        <result column="nickname" property="nickname" jdbcType="VARCHAR"/>
        <result column="date_joined" property="dateJoined" jdbcType="DATE"/>
        <result column="position" property="position" jdbcType="VARCHAR"/>
        <result column="mobile" property="mobile" jdbcType="VARCHAR"/>
        <result column="email" property="email" jdbcType="VARCHAR"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="rb_role_id" property="rbRoleId" jdbcType="INTEGER"/>
    </resultMap>


    <resultMap id="ResultMapWithBLOBs" type="com.utonw.dealer.api.entity.erp.User" extends="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <result column="remark" property="remark" jdbcType="LONGVARCHAR"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        uuid, id, job_number, password, active_flg, user_type, company_id,dept_id, id_card,
        realname,nickname, date_joined, position, mobile, email, created_at,commissionRate,
        data_access_level,account_name
    </sql>
    <sql id="Blob_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        remark
    </sql>
    <select id="selectByMobile" resultMap="BaseResultMap" parameterType="java.lang.String">
    	select
    	<include refid="Base_Column_List"/>
    	,verifiCode,creatverifiCodetime
    	from user
    	where mobile = #{mobile,jdbcType=VARCHAR}
    </select>
    <update id="updateverifiCode">
    	update user set verifiCode = #{result},creatverifiCodetime = date_format(now(),'%Y-%m-%d %h:%i:%s') where mobile = #{mobile}
    </update>
    <update id="updatePasswordofmobile">
    	update user set password = #{password} where mobile = #{mobile}
    </update>
    <select id="selectByPrimaryKey" resultMap="ResultMapWithBLOBs" parameterType="java.lang.String">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        <include refid="Base_Column_List"/>
        ,
        <include refid="Blob_Column_List"/>
        from user
        where uuid = #{uuid,jdbcType=VARCHAR}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from user
        where uuid = #{uuid,jdbcType=VARCHAR}
    </delete>
    <insert id="insert" parameterType="com.utonw.dealer.api.entity.erp.User">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into user (uuid, id, job_number,
        password, active_flg, user_type,
        company_id,dept_id, id_card, realname,
        nickname, date_joined, position,
        mobile, email, created_at,
        remark,commissionRate,account_name)
        values (#{uuid,jdbcType=VARCHAR}, #{id,jdbcType=INTEGER}, #{jobNumber,jdbcType=VARCHAR},
        #{password,jdbcType=VARCHAR}, #{activeFlg,jdbcType=INTEGER}, #{userType,jdbcType=VARCHAR},
        #{companyId,jdbcType=INTEGER},#{deptId,jdbcType=INTEGER}, #{idCard,jdbcType=VARCHAR},
        #{realname,jdbcType=VARCHAR},
        #{nickname,jdbcType=VARCHAR}, #{dateJoined,jdbcType=DATE}, #{position,jdbcType=VARCHAR},
        #{mobile,jdbcType=VARCHAR}, #{email,jdbcType=VARCHAR}, #{createdAt,jdbcType=TIMESTAMP},
        #{remark,jdbcType=LONGVARCHAR},#{commissionRate,jdbcType=DOUBLE},#{accountName,jdbcType=VARCHAR})
    </insert>
    <insert id="insertSelective" parameterType="com.utonw.dealer.api.entity.erp.User">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into user
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="uuid != null">
                uuid,
            </if>
            <if test="id != null">
                id,
            </if>
            <if test="jobNumber != null">
                job_number,
            </if>
            <if test="password != null">
                password,
            </if>
            <if test="sex != null">
                sex,
            </if>
            <if test="activeFlg != null">
                active_flg,
            </if>
            <if test="userType != null">
                user_type,
            </if>
            <if test="companyId != null">
                company_id,
            </if>
            <if test="deptId != null">
                dept_id,
            </if>
            <if test="idCard != null">
                id_card,
            </if>
            <if test="realname != null">
                realname,
            </if>
            <if test="nickname != null">
                nickname,
            </if>
            <if test="dateJoined != null">
                date_joined,
            </if>
            <if test="position != null">
                position,
            </if>
            <if test="mobile != null">
                mobile,
            </if>
            <if test="email != null">
                email,
            </if>
            <if test="createdAt != null">
                created_at,
            </if>
            <if test="remark != null">
                remark,
            </if>
            <if test="commissionRate != null">
                commissionRate,
            </if>
            <if test="dataAccessLevel != null">
                data_access_level,
            </if>
            <if test="accountName != null">
                account_name,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="uuid != null">
                #{uuid,jdbcType=VARCHAR},
            </if>
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="jobNumber != null">
                #{jobNumber,jdbcType=VARCHAR},
            </if>
            <if test="password != null">
                #{password,jdbcType=VARCHAR},
            </if>
            <if test="sex != null">
                #{sex,jdbcType=VARCHAR},
            </if>
            <if test="activeFlg != null">
                #{activeFlg,jdbcType=INTEGER},
            </if>
            <if test="userType != null">
                #{userType,jdbcType=VARCHAR},
            </if>
            <if test="companyId != null">
                #{companyId,jdbcType=INTEGER},
            </if>
            <if test="deptId != null">
                #{deptId,jdbcType=INTEGER},
            </if>
            <if test="idCard != null">
                #{idCard,jdbcType=VARCHAR},
            </if>
            <if test="realname != null">
                #{realname,jdbcType=VARCHAR},
            </if>
            <if test="nickname != null">
                #{nickname,jdbcType=VARCHAR},
            </if>
            <if test="dateJoined != null">
                #{dateJoined,jdbcType=DATE},
            </if>
            <if test="position != null">
                #{position,jdbcType=VARCHAR},
            </if>
            <if test="mobile != null">
                #{mobile,jdbcType=VARCHAR},
            </if>
            <if test="email != null">
                #{email,jdbcType=VARCHAR},
            </if>
            <if test="createdAt != null">
                #{createdAt,jdbcType=TIMESTAMP},
            </if>
            <if test="remark != null">
                #{remark,jdbcType=LONGVARCHAR},
            </if>
            <if test="commissionRate != null">
                #{commissionRate,jdbcType=double},
            </if>
            <if test="dataAccessLevel != null">
                #{dataAccessLevel,jdbcType=TINYINT},
            </if>
            <if test="accountName != null">
                #{accountName,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>
    <select id="selectPasswordover" resultType="java.lang.String">
    	select password from user where uuid = #{uuid,jdbcType=VARCHAR}
    </select>
    <select id="selectUUID" resultType="java.lang.String">
        select id from user where realname = #{realname,jdbcType=VARCHAR}
    </select>
    <update id="updateByPrimaryKeySelective" parameterType="com.utonw.dealer.api.entity.erp.User">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update user
        <set>
            <if test="id != null">
                id = #{id,jdbcType=INTEGER},
            </if>
            <if test="jobNumber != null">
                job_number = #{jobNumber,jdbcType=VARCHAR},
            </if>
            <if test="password != null">
                password = #{password,jdbcType=VARCHAR},
            </if>
            <if test="sex != null">
                sex = #{sex,jdbcType=VARCHAR},
            </if>
            <if test="activeFlg != null">
                active_flg = #{activeFlg,jdbcType=INTEGER},
            </if>
            <if test="userType != null">
                user_type = #{userType,jdbcType=VARCHAR},
            </if>
            <if test="companyId != null">
                company_id = #{companyId,jdbcType=INTEGER},
            </if>
            <if test="deptId != null">
                dept_id = #{deptId,jdbcType=INTEGER},
            </if>
            <if test="idCard != null">
                id_card = #{idCard,jdbcType=VARCHAR},
            </if>
            <if test="realname != null">
                realname = #{realname,jdbcType=VARCHAR},
            </if>
            <if test="nickname != null">
                nickname = #{nickname,jdbcType=VARCHAR},
            </if>
            <if test="dateJoined != null">
                date_joined = #{dateJoined,jdbcType=DATE},
            </if>
            <if test="position != null">
                position = #{position,jdbcType=VARCHAR},
            </if>
            <if test="mobile != null">
                mobile = #{mobile,jdbcType=VARCHAR},
            </if>
            <if test="email != null">
                email = #{email,jdbcType=VARCHAR},
            </if>
            <if test="createdAt != null">
                created_at = #{createdAt,jdbcType=TIMESTAMP},
            </if>
            <if test="remark != null">
                remark = #{remark,jdbcType=LONGVARCHAR},
            </if>
            <if test="commissionRate != null">
                commissionRate = #{commissionRate,jdbcType=DOUBLE},
            </if>
            <if test="dataAccessLevel != null">
                data_access_level = #{dataAccessLevel,jdbcType=TINYINT},
            </if>
            <if test="accountName != null">
                account_name = #{accountName,jdbcType=VARCHAR},
            </if>
        </set>
        where uuid = #{uuid,jdbcType=VARCHAR}
    </update>
    <update id="updateByPrimaryKeyWithBLOBs" parameterType="com.utonw.dealer.api.entity.erp.User">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update user
        set id = #{id,jdbcType=INTEGER},
        job_number = #{jobNumber,jdbcType=VARCHAR},
        password = #{password,jdbcType=VARCHAR},
        active_flg = #{activeFlg,jdbcType=INTEGER},
        user_type = #{userType,jdbcType=VARCHAR},
        company_id = #{companyId,jdbcType=INTEGER},
        dept_id = #{deptId,jdbcType=INTEGER},
        id_card = #{idCard,jdbcType=VARCHAR},
        realname = #{realname,jdbcType=VARCHAR},
        nickname = #{nickname,jdbcType=VARCHAR},
        date_joined = #{dateJoined,jdbcType=DATE},
        position = #{position,jdbcType=VARCHAR},
        mobile = #{mobile,jdbcType=VARCHAR},
        email = #{email,jdbcType=VARCHAR},
        created_at = #{createdAt,jdbcType=TIMESTAMP},
        remark = #{remark,jdbcType=LONGVARCHAR},
        commissionRate = #{commissionRate,jdbcType=DOUBLE},
        account_name = #{accountName,jdbcType=DOUBLE}
        where uuid = #{uuid,jdbcType=VARCHAR}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.utonw.dealer.api.entity.erp.User">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update user
        set id = #{id,jdbcType=INTEGER},
        job_number = #{jobNumber,jdbcType=VARCHAR},
        password = #{password,jdbcType=VARCHAR},
        active_flg = #{activeFlg,jdbcType=INTEGER},
        user_type = #{userType,jdbcType=VARCHAR},
        company_id = #{companyId,jdbcType=INTEGER},
        dept_id = #{deptId,jdbcType=INTEGER},
        id_card = #{idCard,jdbcType=VARCHAR},
        realname = #{realname,jdbcType=VARCHAR},
        nickname = #{nickname,jdbcType=VARCHAR},
        date_joined = #{dateJoined,jdbcType=DATE},
        position = #{position,jdbcType=VARCHAR},
        mobile = #{mobile,jdbcType=VARCHAR},
        email = #{email,jdbcType=VARCHAR},
        created_at = #{createdAt,jdbcType=TIMESTAMP},
        commissionRate = #{commissionRate,jdbcType=DOUBLE},
        account_name = #{accountName,jdbcType=DOUBLE}
        where uuid = #{uuid,jdbcType=VARCHAR}
    </update>
    <select id="verifyLogin" resultMap="BaseResultMap" parameterType="java.lang.String">
        <!--
            登录验证
        -->
        select
        <include refid="Base_Column_List"/>
        ,
        <include refid="Blob_Column_List"/>
        from user
        where 1=1
        AND id_card = #{jobNumber,jdbcType=VARCHAR} OR mobile = #{jobNumber,jdbcType=VARCHAR}
            OR email = #{jobNumber,jdbcType=VARCHAR} OR account_name =  #{jobNumber,jdbcType=VARCHAR}
        AND active_flg = 1
    </select>


    <select id="getRoleUserExtendList" resultMap="UserRoleExtendMap"
            parameterType="com.utonw.dealer.api.vo.UserRoleIdVo">
        SELECT
        u.id as id,
        u.uuid as uuid,
        u.job_number as jobNumber,
        u.password as password,
        u.active_flg as activeFlg,
        u.user_type as userType,
        u.company_id as companyId,
        u.dept_id as deptId,
        u.id_card as idCard,
        u.realname as realname,
        u.nickname as nickname,
        u.date_joined as dateJoined,
        u.position as position,
        u.mobile as mobile,
        u.email as email,
        u.created_at as createdAt,
        ru.rb_role_id as rbRoleId
        FROM
        user u
        LEFT JOIN role_user ru ON ru.rb_user_id = u.uuid

        where 1=1
        <if test="uuid != null">
            and u.uuid = #{uuid ,jdbcType=INTEGER}
        </if>
        <if test="realname != null">
            and u.realname LIKE CONCAT('%',#{realname},'%')
        </if>
    </select>

    <resultMap id="userListPageResultMap" type="com.utonw.dealer.api.entity.erp.User">
        <id column="uuid" property="uuid" jdbcType="VARCHAR"/>
        <result column="id" property="id" jdbcType="INTEGER"/>
        <result column="job_number" property="jobNumber" jdbcType="VARCHAR"/>
        <result column="password" property="password" jdbcType="VARCHAR"/>
        <result column="sex" property="sex" jdbcType="VARCHAR"/>
        <result column="active_flg" property="activeFlg" jdbcType="INTEGER"/>
        <result column="user_type" property="userType" jdbcType="VARCHAR"/>
        <result column="company_id" property="companyId" jdbcType="INTEGER"/>
        <result column="dept_id" property="deptId" jdbcType="INTEGER"/>
        <result column="id_card" property="idCard" jdbcType="VARCHAR"/>
        <result column="realname" property="realname" jdbcType="VARCHAR"/>
        <result column="nickname" property="nickname" jdbcType="VARCHAR"/>
        <result column="date_joined" property="dateJoined" jdbcType="DATE"/>
        <result column="position" property="position" jdbcType="VARCHAR"/>
        <result column="mobile" property="mobile" jdbcType="VARCHAR"/>
        <result column="email" property="email" jdbcType="VARCHAR"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <!-- 关联Company -->
        <association property="company" column="company_id" javaType="com.utonw.dealer.api.entity.erp.Company">
            <id column="companyId" property="id" jdbcType="INTEGER"/>
            <result column="name" property="name" jdbcType="VARCHAR"/>
            <!--<result column="dialect" property="dialect" jdbcType="VARCHAR"/>-->
            <!--<result column="parent_id" property="parentId" jdbcType="INTEGER"/>-->
            <!--<result column="principal" property="principal" jdbcType="VARCHAR"/>-->
            <!--<result column="telephone" property="telephone" jdbcType="VARCHAR"/>-->
            <!--<result column="start_service_date" property="startServiceDate" jdbcType="DATE"/>-->
            <!--<result column="stop_service_date" property="stopServiceDate" jdbcType="DATE"/>-->
            <!--<result column="service_version" property="serviceVersion" jdbcType="VARCHAR"/>-->
            <!--<result column="repayment_remind_days" property="repaymentRemindDays" jdbcType="INTEGER"/>-->
            <!--<result column="manage_location" property="manageLocation" jdbcType="VARCHAR"/>-->
            <!--<result column="business_license" property="businessLicense" jdbcType="VARCHAR"/>-->
            <!--<result column="organization_code" property="organizationCode" jdbcType="VARCHAR"/>-->
            <!--<result column="tax_card_code" property="taxCardCode" jdbcType="VARCHAR"/>-->
            <!--<result column="register_at" property="registerAt" jdbcType="DATE"/>-->
            <!--<result column="pledge_account" property="pledgeAccount" jdbcType="VARCHAR"/>-->
            <!--<result column="pledge_amount" property="pledgeAmount" jdbcType="DECIMAL"/>-->
            <!--<result column="overdue_rate" property="overdueRate" jdbcType="DECIMAL"/>-->
            <!--<result column="superminiature_default_money" property="superminiatureDefaultMoney"-->
            <!--jdbcType="DECIMAL"/>-->
            <!--<result column="commission_index" property="commissionIndex" jdbcType="DECIMAL"/>-->
            <!--<result column="management_cost_rate" property="managementCostRate" jdbcType="DECIMAL"/>-->
            <!--<result column="valid_flg" property="validFlg" jdbcType="BIT"/>-->
            <!--<result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>-->
            <!--<result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>-->
        </association>
        <association property="dept" column="dept_id"
                     javaType="com.utonw.dealer.api.entity.erp.Dept">
            <result column="deptName" property="name" jdbcType="VARCHAR"/>
        </association>
    </resultMap>
    <!-- 分页查询用户列表 -->
    <select id="getUserListPage" resultMap="userListPageResultMap" parameterType="map">
        SELECT DISTINCT u.*, com.id AS companyId , com.name, de.name as deptName FROM user u
        LEFT JOIN company com ON u.company_id = com.id
        LEFT JOIN dept de ON u.dept_id = de.id
        LEFT JOIN role_user ru ON ru.rb_user_id = u.uuid
        LEFT JOIN role_manage rm on rm.role_id = ru.rb_role_id
        WHERE u.active_flg = 1
        <if test="dataAccessLevel != 4">
        AND u.company_id IN (
        SELECT
		company_id FROM USER WHERE active_flg = 1
           	 AND uuid = #{userId,jdbcType=VARCHAR}
		)
		</if>  
        <if test="mobile != null and mobile != ''">
            AND u.mobile LIKE CONCAT('%',#{mobile},'%')
        </if>
        <if test="role != null and role != ''">
            AND rm.role_name LIKE CONCAT('%',#{role},'%')
        </if>
        <if test="name != null and name != ''">
            AND u.realname LIKE CONCAT('%',#{name},'%')
        </if>
        ORDER BY u.created_at DESC
    </select>


    <!-- 根据公司Id的查询名下所有员工 -->
    <select id="getUserListByCompanyId" resultMap="BaseResultMap" parameterType="Integer">
        SELECT * FROM user u WHERE u.active_flg='1' and u.company_id= #{companyId,jdbcType=VARCHAR}
    </select>

    <!-- 根据公司Id和部门Id查询名下所有员工 -->
    <select id="queryComIdDeptId" resultMap="BaseResultMap" parameterType="Integer">
        SELECT * FROM user u WHERE u.active_flg='1' and u.company_id= #{companyId,jdbcType=VARCHAR}
        and u.dept_id= #{deptId,jdbcType=INTEGER}
    </select>

	<select id="queryComIdDeptIds" resultMap="BaseResultMap" parameterType="Integer">
        SELECT * FROM user u WHERE u.active_flg='1' and u.company_id= #{param1}
        and u.dept_id in 
			<foreach item="item" collection="param2" open="(" separator="," close=")"
                     index="index">
                #{item}
            </foreach>
    </select>

    <!-- 验证用户手机号码与身份证号是否存在 -->
    <select id="verifyIdCard" resultType="com.utonw.dealer.api.entity.erp.User" parameterType="map">
        SELECT
        <include refid="Base_Column_List"/>
        ,
        <include refid="Base_Column_List"/>
        FROM user u WHERE 1 = 1
        AND u.active_flg='1'
        <if test="idCard != null">
            AND u.id_card = #{idCard}
        </if>
        <if test="mobile != null">
            AND u.mobile = #{mobile}
        </if>
        <if test="email != null">
            AND u.email = #{email}
        </if>
    </select>

    <!-- 关联查询出借款信息 -->
    <resultMap id="queryBusinessDetailResultMap" type="com.utonw.dealer.api.entity.erp.User">

        <id column="uuid" property="uuid" jdbcType="VARCHAR"/>
        <result column="realname" property="realname" jdbcType="VARCHAR"/>
        <result column="mobile" property="mobile" jdbcType="VARCHAR"/>
        <result column="loanMonthCount" property="loanMonthCount" jdbcType="INTEGER"/>
        <result column="loanMonthMoney" property="loanMonthMoney" jdbcType="DECIMAL"/>
        <result column="cycle" property="cycle" jdbcType="VARCHAR"/>

        <association property="company" column="company_id"
                     javaType="com.utonw.dealer.api.entity.erp.Company">
            <result column="company_name" property="name" jdbcType="VARCHAR"/>
        </association>

        <association property="dept" column="dept_id" javaType="com.utonw.dealer.api.entity.erp.Dept">
            <result column="dept_name" property="name" jdbcType="VARCHAR"/>
        </association>

    </resultMap>

    <!-- 查询业务明细 -->
    <select id="queryBusinessDetail" resultMap="queryBusinessDetailResultMap">
        select
        u.uuid, u.realname, u.mobile, count(1) loanMonthCount,
        sum(li.loan_money)loanMonthMoney,
        d.name as
        dept_name, com.name as company_name,
        date_format(now(),'%Y-%m') cycle
        from loan_info li
        left join user u on li.responsible_cm_id = u.uuid
        left join company com on u.company_id = com.id
        left join dept d on u.dept_id = d.id
        where li.is_chargedoff = 1 and date_format(li.chargedoff_at,'%Y-%m') =
        date_format(now(),'%Y-%m')
        <if test="mobile != null" >
            and u.mobile = #{mobile}
        </if>
        group by li.responsible_cm_id
    </select>

    <resultMap id="verifyUserResultMap" type="com.utonw.dealer.api.entity.erp.User">
        <id column="uuid" property="uuid" jdbcType="VARCHAR"/>
        <result column="id" property="id" jdbcType="INTEGER"/>
        <result column="job_number" property="jobNumber" jdbcType="VARCHAR"/>
        <result column="password" property="password" jdbcType="VARCHAR"/>
        <result column="sex" property="sex" jdbcType="VARCHAR"/>
        <result column="active_flg" property="activeFlg" jdbcType="INTEGER"/>
        <result column="user_type" property="userType" jdbcType="VARCHAR"/>
        <result column="company_id" property="companyId" jdbcType="INTEGER"/>
        <result column="dept_id" property="deptId" jdbcType="INTEGER"/>
        <result column="id_card" property="idCard" jdbcType="VARCHAR"/>
        <result column="realname" property="realname" jdbcType="VARCHAR"/>
        <result column="nickname" property="nickname" jdbcType="VARCHAR"/>
        <result column="date_joined" property="dateJoined" jdbcType="DATE"/>
        <result column="position" property="position" jdbcType="VARCHAR"/>
        <result column="mobile" property="mobile" jdbcType="VARCHAR"/>
        <result column="email" property="email" jdbcType="VARCHAR"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <association property="company" column="company_id"
                     javaType="com.utonw.dealer.api.entity.erp.Company">
            <result column="companyName" property="name" jdbcType="VARCHAR"/>
        </association>
        <association property="dept" column="dept_id" javaType="com.utonw.dealer.api.entity.erp.Dept">
            <result column="deptName" property="name" jdbcType="VARCHAR"/>
        </association>
    </resultMap>

    <select id="verifyUser" resultMap="verifyUserResultMap" parameterType="string">
        SELECT u.*,com.name companyName, d.name deptName FROM user u
        left join company com on u.company_id = com.id
        left join dept d on u.dept_id = d.id
        where 1=1
        AND id_card = #{jobNumber,jdbcType=VARCHAR} or mobile = #{jobNumber,jdbcType=VARCHAR} or email = #{jobNumber,jdbcType=VARCHAR}
        AND active_flg = 1
    </select>

    <select id="queryRoleType" resultType="String" parameterType="string">
        SELECT distinct  rm.role_name
        FROM user u
        left join role_user ru on ru.rb_user_id = u.uuid
        left join role_manage rm on rm.role_id = ru.rb_role_id
        where 1=1
        AND active_flg = 1
        AND rm.role_name <![CDATA[<>]]> ""
    </select>
    <update id="updateLoanOwner">
    update loan_info set responsible_cm_id=#{param1},teamleader_id=#{param3},dept_id=#{param4} where uuid=#{param2}
</update>
    <update id="updateTaskOwner">
    		update act_ru_task set ASSIGNEE_=#{param1} where ID_=#{param2}
    </update>
	<update id="modifiyTaskApplyUser">
			update act_ru_variable set TEXT_=#{param1} where NAME_='applyuser' and PROC_INST_ID_=#{param2}
	</update>
	<update id="modifiyTaskStartUser">
			update act_ru_identitylink set USER_ID_=#{param1} where TYPE_='starter' and PROC_INST_ID_=#{param2}
	</update>
	<select id="selectAllUser" resultMap="BaseResultMap">
		select * from user  
	</select>

    <select id="selectUserLocateByUserId" resultMap="ResultMapWithBLOBs" parameterType="java.lang.String">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        SELECT
        u.uuid,u.id,u.job_number,u.password,u.active_flg,u.user_type,u.company_id,u.dept_id,
        u.id_card,u.realname,u.nickname,u.date_joined,u.position,u.mobile,u.email,u.created_at,
        u.commissionRate,u.data_access_level,u.remark,u.account_name,
        ul.id AS locate_id,ul.user_id AS locate_userId,
        ul.province AS locate_province,ul.city AS locate_city,
        ul.district AS locate_district, ul.create_date AS locate_create_date
        FROM user u
        LEFT JOIN user_locate ul ON ul.user_id = u.uuid
        WHERE uuid = #{userId}
    </select>

    <select id="getOfflineStaff" resultType="com.utonw.dealer.api.entity.erp.User" parameterType="java.util.Map">
       SELECT
        u.uuid,u.realname
       FROM USER u
       INNER JOIN user_locate ul on u.uuid = ul.user_id inner join role_user ru on u.uuid=ru.rb_user_id
       WHERE u.active_flg = 1
       AND ul.province =  #{province,jdbcType=VARCHAR}
       AND ul.city =  #{city,jdbcType=VARCHAR}
       AND ul.district = #{district,jdbcType=VARCHAR}
       and ru.rb_role_id=#{role}
    </select>
    
    <select id="selectAccountName" resultType="java.lang.String" parameterType="java.lang.String">
    	SELECT account_name
		FROM user
		WHERE uuid = #{uuid}
    </select>
    <select id="getUserInfoList" resultType="java.lang.String" parameterType="java.lang.String">
   SELECT    mobile
     FROM role_manage rm
    INNER JOIN role_user ru ON rm.role_id = ru.rb_role_id
    INNER JOIN user ur ON ur.uuid = ru.rb_user_id
    WHERE
    rm.is_alarm = 'Y' and rm.is_show='Y'
    </select>
</mapper>