<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.utonw.utonerp.mapper.RepaymentPlanMapper" >
  <resultMap id="BaseResultMap" type="com.utonw.dealer.api.entity.RepaymentPlan" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="record_id" property="recordId" jdbcType="INTEGER" />
    <result column="task_id" property="taskId" jdbcType="VARCHAR" />
    <result column="car_name" property="carName" jdbcType="VARCHAR" />
    <result column="loan_time" property="loanTime" jdbcType="VARCHAR" />
    <result column="loan_amt" property="loanAmt" jdbcType="DOUBLE" />
    <result column="cyclicity" property="cyclicity" jdbcType="VARCHAR" />
    <result column="interest_rate" property="interestRate" jdbcType="DOUBLE" />
    <result column="repaymen_time" property="repaymenTime" jdbcType="VARCHAR" />
    <result column="repaymen_amt" property="repaymenAmt" jdbcType="DOUBLE" />
    <result column="out_account_time" property="outAccountTime" jdbcType="VARCHAR" />
    <result column="out_account_voucher" property="outAccountVoucher" jdbcType="VARCHAR" />
    <result column="order_id" property="orderId" jdbcType="VARCHAR" />
    <result column="reg_date" property="regDate" jdbcType="DATE" />
    <result column="reg_time" property="regTime" jdbcType="TIMESTAMP" />
    <result column="borrowerd" property="borrowerd" jdbcType="VARCHAR" />
    <result column="order_num" property="orderNum" jdbcType="VARCHAR" />
    <result column="end_time" property="endTime" jdbcType="VARCHAR" />
    <result column="end_type" property="endType" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    record_id, task_id, car_name, loan_time, loan_amt, cyclicity, interest_rate, repaymen_time, 
    repaymen_amt, out_account_time, out_account_voucher, order_id, reg_date, reg_time,borrowerd,order_num
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from repayment_plan
    where record_id = #{recordId,jdbcType=INTEGER}
  </select>
  <select id="selectrepaymentPlan" resultMap="BaseResultMap" parameterType="java.lang.String" >
  SELECT
	record_id,
	task_id,
	car_name,
	loan_time,
	loan_amt,
	cyclicity,
	interest_rate,
	repaymen_time,
	repaymen_amt,
	out_account_time,
	out_account_voucher,
	order_id,
	reg_date,
	reg_time,
	borrowerd,
	order_num
FROM
	repayment_plan
WHERE
	order_id = #{orderId}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from repayment_plan
    where record_id = #{recordId,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.utonw.dealer.api.entity.RepaymentPlan" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into repayment_plan (record_id, task_id, car_name, 
      loan_time, loan_amt, cyclicity, 
      interest_rate, repaymen_time, repaymen_amt, 
      out_account_time, out_account_voucher, order_id, 
      reg_date, reg_time,borrowerd,order_num)
    values (#{recordId,jdbcType=INTEGER}, #{taskId,jdbcType=VARCHAR}, #{carName,jdbcType=VARCHAR}, 
      #{loanTime,jdbcType=VARCHAR}, #{loanAmt,jdbcType=DOUBLE}, #{cyclicity,jdbcType=VARCHAR}, 
      #{interestRate,jdbcType=DOUBLE}, #{repaymenTime,jdbcType=VARCHAR}, #{repaymenAmt,jdbcType=DOUBLE}, 
      #{outAccountTime,jdbcType=VARCHAR}, #{outAccountVoucher,jdbcType=VARCHAR}, #{orderId,jdbcType=VARCHAR}, 
      #{regDate,jdbcType=DATE}, #{regTime,jdbcType=TIMESTAMP},#{borrowerd,jdbcType=VARCHAR}),#{orderNum,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.utonw.dealer.api.entity.RepaymentPlan" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into repayment_plan
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="recordId != null" >
        record_id,
      </if>
      <if test="taskId != null" >
        task_id,
      </if>
      <if test="carName != null" >
        car_name,
      </if>
      <if test="loanTime != null" >
        loan_time,
      </if>
      <if test="loanAmt != null" >
        loan_amt,
      </if>
      <if test="cyclicity != null" >
        cyclicity,
      </if>
      <if test="interestRate != null" >
        interest_rate,
      </if>
      <if test="repaymenTime != null" >
        repaymen_time,
      </if>
      <if test="repaymenAmt != null" >
        repaymen_amt,
      </if>
      <if test="outAccountTime != null" >
        out_account_time,
      </if>
      <if test="outAccountVoucher != null" >
        out_account_voucher,
      </if>
      <if test="orderId != null" >
        order_id,
      </if>
      <if test="regDate != null" >
        reg_date,
      </if>
      <if test="regTime != null" >
        reg_time,
      </if>
      <if test="borrowerd != null" >
        borrowerd,
      </if>
      <if test="orderNum != null" >
        order_num,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="recordId != null" >
        #{recordId,jdbcType=INTEGER},
      </if>
      <if test="taskId != null" >
        #{taskId,jdbcType=VARCHAR},
      </if>
      <if test="carName != null" >
        #{carName,jdbcType=VARCHAR},
      </if>
      <if test="loanTime != null" >
        #{loanTime,jdbcType=VARCHAR},
      </if>
      <if test="loanAmt != null" >
        #{loanAmt,jdbcType=DOUBLE},
      </if>
      <if test="cyclicity != null" >
        #{cyclicity,jdbcType=VARCHAR},
      </if>
      <if test="interestRate != null" >
        #{interestRate,jdbcType=DOUBLE},
      </if>
      <if test="repaymenTime != null" >
        #{repaymenTime,jdbcType=VARCHAR},
      </if>
      <if test="repaymenAmt != null" >
        #{repaymenAmt,jdbcType=DOUBLE},
      </if>
      <if test="outAccountTime != null" >
        #{outAccountTime,jdbcType=VARCHAR},
      </if>
      <if test="outAccountVoucher != null" >
        #{outAccountVoucher,jdbcType=VARCHAR},
      </if>
      <if test="orderId != null" >
        #{orderId,jdbcType=VARCHAR},
      </if>
      <if test="regDate != null" >
        #{regDate,jdbcType=DATE},
      </if>
      <if test="regTime != null" >
        #{regTime,jdbcType=TIMESTAMP},
      </if>
      <if test="borrowerd != null" >
      #{borrowerd,jdbcType=VARCHAR},
    </if>
      <if test="orderNum != null" >
        #{orderNum,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.utonw.dealer.api.entity.RepaymentPlan" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update repayment_plan
    <set >
      <if test="taskId != null" >
        task_id = #{taskId,jdbcType=VARCHAR},
      </if>
      <if test="carName != null" >
        car_name = #{carName,jdbcType=VARCHAR},
      </if>
      <if test="loanTime != null" >
        loan_time = #{loanTime,jdbcType=VARCHAR},
      </if>
      <if test="loanAmt != null" >
        loan_amt = #{loanAmt,jdbcType=DOUBLE},
      </if>
      <if test="cyclicity != null" >
        cyclicity = #{cyclicity,jdbcType=VARCHAR},
      </if>
      <if test="interestRate != null" >
        interest_rate = #{interestRate,jdbcType=DOUBLE},
      </if>
      <if test="repaymenTime != null" >
        repaymen_time = #{repaymenTime,jdbcType=VARCHAR},
      </if>
      <if test="repaymenAmt != null" >
        repaymen_amt = #{repaymenAmt,jdbcType=DOUBLE},
      </if>
      <if test="outAccountTime != null" >
        out_account_time = #{outAccountTime,jdbcType=VARCHAR},
      </if>
      <if test="outAccountVoucher != null" >
        out_account_voucher = #{outAccountVoucher,jdbcType=VARCHAR},
      </if>
      <if test="orderId != null" >
        order_id = #{orderId,jdbcType=VARCHAR},
      </if>
      <if test="regDate != null" >
        reg_date = #{regDate,jdbcType=DATE},
      </if>
      <if test="regTime != null" >
        reg_time = #{regTime,jdbcType=TIMESTAMP},
      </if>
      <if test="borrowerd != null" >
        borrowerd = #{borrowerd,jdbcType=VARCHAR},
      </if>
      <if test="orderNum != null" >
        order_num = #{orderNum,jdbcType=VARCHAR},
      </if>
    </set>
    where record_id = #{recordId,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.utonw.dealer.api.entity.RepaymentPlan" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update repayment_plan
    set task_id = #{taskId,jdbcType=VARCHAR},
      car_name = #{carName,jdbcType=VARCHAR},
      loan_time = #{loanTime,jdbcType=VARCHAR},
      loan_amt = #{loanAmt,jdbcType=DOUBLE},
      cyclicity = #{cyclicity,jdbcType=VARCHAR},
      interest_rate = #{interestRate,jdbcType=DOUBLE},
      repaymen_time = #{repaymenTime,jdbcType=VARCHAR},
      repaymen_amt = #{repaymenAmt,jdbcType=DOUBLE},
      out_account_time = #{outAccountTime,jdbcType=VARCHAR},
      out_account_voucher = #{outAccountVoucher,jdbcType=VARCHAR},
      order_id = #{orderId,jdbcType=VARCHAR},
      reg_date = #{regDate,jdbcType=DATE},
      reg_time = #{regTime,jdbcType=TIMESTAMP},
      borrowerd = #{borrowerd,jdbcType=VARCHAR}
    where record_id = #{recordId,jdbcType=INTEGER}
  </update>
  <select id="selectByOrderIds" resultMap="BaseResultMap">
    select * from repayment_plan
    WHERE
    order_id in
    <foreach collection="list" open="(" close=")" separator="," item="item">
      #{item}
    </foreach>
  </select>

  <select id="selectAllByTaskList" resultType="java.util.Map" parameterType="com.utonw.dealer.api.dto.request.OrderPageRequest" >
    SELECT
    *,
     case
     	when wfv.TASK_DEF_KEY_ is null then '逾期'
       else wfv.NAME_ end  as name
    FROM   repayment_plan rp LEFT JOIN (SELECT * FROM workflowview wfv where wfv.ASSIGNEE_ = #{uuid, jdbcType=VARCHAR}
       AND wfv.PROC_KEY ='CarDealerRepayment'
            AND wfv.TASK_DEF_KEY_  NOT IN ('information_verification','installCamera_signContract','evaluate_install_collateral'
       ,'sign_contract','dismantling')
      UNION
      SELECT * FROM workflowview wfv WHERE  wfv.ASSIGNEE_ is null AND wfv.GROUP_ID_ in
      (
        SELECT DISTINCT rb_role_id FROM role_user WHERE rb_user_id = #{uuid, jdbcType=VARCHAR}
      )  AND wfv.PROC_KEY = 'CarDealerRepayment'      AND wfv.TASK_DEF_KEY_  NOT IN ('information_verification','installCamera_signContract','evaluate_install_collateral'
       ,'sign_contract','dismantling')) wfv on rp.order_id=wfv.BUSINESS_KEY_
      where
      ((rp.end_time is  null and  DATEDIFF(now(),DATE_FORMAT(rp.repaymen_time,'%Y-%m-%d'))>0) or wfv.TASKID is not null)
      <if test="loanStatus!='all' and loanStatus!='overdue'">
          and wfv.TASK_DEF_KEY_=#{loanStatus}
      </if>
      <if test=" loanStatus=='overdue'">
          and wfv.TASK_DEF_KEY_ is null 
      </if>
     order by wfv.CREATE_TIME_ desc
  </select>
  <select id="selectByOrderId" resultMap="BaseResultMap">
    select * from repayment_plan where order_id=#{param1}

  </select>
   <update id="updateByOrderId" parameterType="com.utonw.dealer.api.entity.RepaymentPlan" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update repayment_plan
    <set >
      <if test="endType != null" >
        end_type = #{endType,jdbcType=VARCHAR},
      </if>
      <if test="endTime != null" >
        end_time = #{endTime},
      </if>
    </set>
    where order_id = #{orderId,jdbcType=VARCHAR}
  </update>
</mapper>